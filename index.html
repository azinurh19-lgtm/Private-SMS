<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Ultra v34 | Pro Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon: #00f2ff; --accent: linear-gradient(135deg, #00f2ff 0%, #7000ff 100%);
            --bg: #010409; --panel: rgba(13, 17, 23, 0.98);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: #fff; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Modern UI Layers */
        .page { position: fixed; inset: 0; display: flex; flex-direction: column; background: var(--bg); z-index: 10; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass { background: var(--panel); backdrop-filter: blur(30px); border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); padding: 40px; width: 90%; max-width: 420px; margin: auto; text-align: center; box-shadow: 0 40px 100px rgba(0,0,0,0.8); }

        /* Inputs & Action Components */
        .inp { width: 100%; background: #0d1117; border: 1px solid #30363d; padding: 20px; border-radius: 20px; color: #fff; font-size: 16px; margin-bottom: 20px; outline: none; }
        .inp:focus { border-color: var(--neon); }
        .btn { width: 100%; padding: 18px; border-radius: 20px; border: none; background: var(--accent); color: #fff; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(112, 0, 255, 0.4); }

        /* Chat System */
        .header { padding: 15px 20px; background: rgba(1, 4, 9, 0.9); border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; }
        .av { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #000; }
        .flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 22px; font-size: 15px; animation: slide 0.3s ease; }
        @keyframes slide { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        .sent { align-self: flex-end; background: #007aff; border-bottom-right-radius: 4px; }
        .recv { align-self: flex-start; background: #232d36; border-bottom-left-radius: 4px; }
        .msg img { width: 100%; border-radius: 12px; margin-top: 5px; }

        /* Call Overlay - Critical Priority */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        #rem-vid { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #loc-vid { width: 120px; height: 170px; border-radius: 20px; position: absolute; top: 40px; right: 20px; border: 2px solid var(--neon); z-index: 100; object-fit: cover; }
        .call-meta { z-index: 101; text-align: center; }
        .call-ctrl { z-index: 101; display: flex; gap: 40px; }
        .c-btn { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .hang { background: #ff3b30; } .pick { background: #34c759; }

        .footer { padding: 15px 20px; background: #0d1117; display: flex; gap: 10px; align-items: center; padding-bottom: 30px; }
        .in-wrap { flex: 1; background: #161b22; border-radius: 30px; display: flex; align-items: center; padding: 0 15px; border: 1px solid #30363d; }
        .in-wrap input { flex: 1; background: none; border: none; padding: 12px; color: #fff; outline: none; }
    </style>
</head>
<body>

    <audio id="ring" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="ping" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="pg-reg" class="page">
        <div class="glass">
            <h1 style="font-size:38px; letter-spacing:-1px;">Elite<span style="color:var(--neon)">V34</span></h1>
            <p style="color:#8b949e; margin-bottom:30px;">ULTRA-LINK DEPLOYED</p>
            <input type="text" id="reg-name" class="inp" placeholder="Node Name">
            <button class="btn" onclick="join()">INITIALIZE LIFETIME</button>
        </div>
    </div>

    <div id="pg-home" class="page hidden">
        <div class="glass">
            <div class="av" id="m-av" style="width:90px; height:90px; font-size:40px; margin:0 auto 20px;">?</div>
            <h2 id="m-name">User</h2>
            <p id="m-pin" style="color:var(--neon); letter-spacing:5px; font-size:26px; margin:15px 0 30px;">000000</p>
            <input type="number" id="t-pin" class="inp" placeholder="Peer Node PIN">
            <button class="btn" onclick="find()">LINK NODE</button>
        </div>
    </div>

    <div id="pg-chat" class="page hidden">
        <div class="header">
            <div style="display:flex; align-items:center; gap:12px;">
                <div onclick="back()" style="cursor:pointer; padding:5px;">✕</div>
                <div class="av" id="c-av" style="width:40px; height:40px;">?</div>
                <div><b id="c-name">Target</b><br><small style="color:#34c759">● ONLINE</small></div>
            </div>
            <div style="display:flex; gap:15px;">
                <button onclick="call('Video')" style="background:none; border:none; cursor:pointer;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                </button>
                <button onclick="call('Voice')" style="background:none; border:none; cursor:pointer;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </button>
            </div>
        </div>
        <div class="flow" id="chat-box"></div>
        <div class="footer">
            <div class="in-wrap">
                <svg onclick="document.getElementById('f-in').click()" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="2" style="cursor:pointer"><path d="M12 5v14M5 12h14"></path></svg>
                <input type="text" id="m-in" placeholder="Message...">
                <input type="file" id="f-in" class="hidden" accept="image/*" onchange="sendImg(this)">
            </div>
            <button class="av" style="width:45px; height:45px; border:none; cursor:pointer;" onclick="send()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <div id="call-ui" class="hidden">
        <video id="rem-vid" autoplay playsinline></video>
        <video id="loc-vid" autoplay playsinline muted></video>
        <div class="call-meta">
            <div class="av" id="call-av" style="width:120px; height:120px; font-size:50px; margin:0 auto 20px; border:3px solid var(--neon);">?</div>
            <h1 id="call-peer">Peer</h1>
            <p id="call-status" style="color:var(--neon); margin-top:10px;">CONNECTING...</p>
        </div>
        <div class="call-ctrl">
            <button id="ans-btn" class="c-btn pick hidden" onclick="ans()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.17-.24c1.05.42 2.19.64 3.39.64a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1c-9.39 0-17-7.61-17-17a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.2.22 2.34.64 3.39a1 1 0 0 1-.24 1.17l-2.2 2.2z"></path></svg>
            </button>
            <button class="c-btn hang" onclick="end()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </button>
        </div>
    </div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let me = JSON.parse(localStorage.getItem('elite_me')) || null;
    let db = JSON.parse(localStorage.getItem('elite_db')) || {};
    let target = null;
    let stream = null;
    let busy = false;
    let syncLock = false;

    window.onload = () => {
        if(me) start();
        document.getElementById('m-in').onkeydown = (e) => e.key === 'Enter' && send();
    };

    function join() {
        let n = document.getElementById('reg-name').value.trim();
        if(!n) return;
        let p = Math.floor(100000 + Math.random() * 900000).toString();
        me = { name: n, pin: p };
        localStorage.setItem('elite_me', JSON.stringify(me));
        req(`action=register&name=${encodeURIComponent(n)}&pin=${p}`);
        start();
    }

    function start() {
        document.getElementById('pg-reg').classList.add('hidden');
        document.getElementById('pg-home').classList.remove('hidden');
        document.getElementById('m-name').innerText = me.name;
        document.getElementById('m-pin').innerText = me.pin;
        document.getElementById('m-av').innerText = me.name[0].toUpperCase();
        setInterval(sync, 1000); // Super fast polling
    }

    function req(p, cb) {
        const s = document.createElement('script');
        s.src = `${API}?${p}&_t=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    }

    function find() {
        let p = document.getElementById('t-pin').value;
        if(!p) return;
        req(`action=getUser&pin=${p}`, "onUser");
    }

    window.onUser = (u) => {
        if(u && u.name) openChat(u.name, u.pin);
        else alert("PIN Invalid");
    };

    function openChat(name, pin) {
        target = pin;
        document.getElementById('pg-home').classList.add('hidden');
        document.getElementById('pg-chat').classList.remove('hidden');
        document.getElementById('c-name').innerText = name;
        document.getElementById('c-av').innerText = name[0].toUpperCase();
        render();
    }

    function render() {
        if(!target) return;
        const box = document.getElementById('chat-box');
        box.innerHTML = "";
        (db[target] || []).forEach(m => {
            if(m.sig) return;
            const content = m.val.startsWith('data:image') ? `<img src="${m.val}">` : m.val;
            box.innerHTML += `<div class="msg ${m.from === me.pin ? 'sent' : 'recv'}">${content}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function send(v = null, sig = false) {
        let val = v || document.getElementById('m-in').value.trim();
        if(!val || !target) return;
        if(!db[target]) db[target] = [];
        db[target].push({ from: me.pin, val, sig });
        localStorage.setItem('elite_db', JSON.stringify(db));
        if(!sig) { render(); document.getElementById('m-in').value = ""; }
        req(`action=send&from=${me.pin}&from_name=${encodeURIComponent(me.name)}&to=${target}&msg=${encodeURIComponent(val)}`);
    }

    function sendImg(el) {
        if(el.files[0]) {
            let r = new FileReader();
            r.onload = (e) => send(e.target.result);
            r.readAsDataURL(el.files[0]);
        }
    }

    // --- CALL SYSTEM ---
    async function call(type) {
        busy = true;
        document.getElementById('call-ui').classList.remove('hidden');
        document.getElementById('call-peer').innerText = document.getElementById('c-name').innerText;
        document.getElementById('ring').play();
        await media(type);
        send(`[SIGNAL_CALL:${type}]`, true);
    }

    async function media(type) {
        try {
            if(stream) stream.getTracks().forEach(t => t.stop());
            stream = await navigator.mediaDevices.getUserMedia({ video: type === 'Video', audio: true });
            document.getElementById('loc-vid').srcObject = stream;
            document.getElementById('loc-vid').classList.toggle('hidden', type === 'Voice');
        } catch(e) { end(); }
    }

    function ans() {
        document.getElementById('ring').pause();
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-status').innerText = "NODE LIVE";
        media(busy).then(() => { document.getElementById('rem-vid').srcObject = stream; });
    }

    function end() {
        document.getElementById('ring').pause();
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('call-ui').classList.add('hidden');
        if(target) req(`action=send&from=${me.pin}&from_name=${encodeURIComponent(me.name)}&to=${target}&msg=[SIGNAL_END]`);
        busy = false;
    }

    // --- GLOBAL SYNC ---
    function sync() {
        if(!me || syncLock) return;
        syncLock = true;
        req(`action=getMessages&myPin=${me.pin}`, "onSync");
    }

    window.onSync = (data) => {
        syncLock = false;
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!db[m.sender]) db[m.sender] = [];
                if(!db[m.sender].some(x => x.val === m.txt)) {
                    let isCall = m.txt.includes("[SIGNAL_CALL:");
                    let isEnd = m.txt === "[SIGNAL_END]";
                    db[m.sender].push({ from: m.sender, val: m.txt, sig: isCall || isEnd });

                    if(isCall) {
                        busy = m.txt.includes("Video") ? "Video" : "Voice";
                        document.getElementById('call-ui').classList.remove('hidden');
                        document.getElementById('ans-btn').classList.remove('hidden');
                        document.getElementById('call-peer').innerText = m.sender_name;
                        document.getElementById('call-status').innerText = `INCOMING ${busy}`;
                        document.getElementById('ring').play();
                    } else if(isEnd) {
                        end();
                    } else {
                        document.getElementById('ping').play();
                        // AUTO-WAKE: Jab bhi message aaye, chat open ho jaye (Unlimited logic)
                        if(target !== m.sender) openChat(m.sender_name, m.sender);
                    }
                }
            });
            localStorage.setItem('elite_db', JSON.stringify(db));
            render();
        }
    };

    function back() {
        document.getElementById('pg-chat').classList.add('hidden');
        document.getElementById('pg-home').classList.remove('hidden');
        target = null;
    }
</script>
</body>
</html>
