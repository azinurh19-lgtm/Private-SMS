<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Private SMS - Master Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #0b141a; --card: #202c33; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body, html { height: 100%; width: 100%; background: var(--bg); color: #e9edef; font-family: sans-serif; overflow: hidden; }

        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; }
        .active { display: flex; }

        .overlay { position: fixed; inset: 0; background: #0b141a; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: var(--card); padding: 30px; border-radius: 24px; width: 100%; max-width: 350px; text-align: center; border: 1px solid #ffffff10; }

        input { width: 100%; padding: 15px; margin: 10px 0; border: none; border-bottom: 2px solid var(--gold); background: #2a3942; color: white; text-align: center; border-radius: 12px 12px 0 0; outline: none; }
        button { width: 100%; padding: 15px; background: var(--gold); border: none; font-weight: bold; border-radius: 12px; color: black; cursor: pointer; transition: 0.2s; }

        .header { height: 65px; background: #202c33; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #0b141a; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; position: relative; }
        .sent { align-self: flex-end; background: #005c4b; color: white; }
        .received { align-self: flex-start; background: #202c33; color: white; }

        .input-bar { height: 70px; background: #202c33; display: flex; padding: 10px; gap: 10px; align-items: center; }
        #m-input { text-align: left; background: #2a3942; border: none; border-radius: 25px; padding: 0 20px; height: 45px; flex: 1; }

        #call-ui { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; transition: 0.3s; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 12px; border: 1px solid var(--gold); object-fit: cover; z-index: 3001; }
        
        .call-info { position: absolute; top: 15%; width: 100%; text-align: center; color: white; z-index: 3002; }
        .call-btns { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 3003; }
        .btn-call { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="scr-reg" class="overlay">
    <div class="card">
        <h2 style="color:var(--gold)">SECURE LOGIN</h2>
        <input type="text" id="reg-name" placeholder="Full Name">
        <button onclick="initAccount()">START CONNECTING</button>
    </div>
</div>

<div id="main-app" class="screen">
    <div class="header">
        <div><b id="u-name"></b> <br> <small id="u-id" style="color:var(--gold)"></small></div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="t-id" placeholder="Friend ID" style="width:70px; margin:0; padding:5px; border-radius:8px;">
            <button onclick="callNow(false)" style="width:40px;">ðŸ“ž</button>
            <button onclick="callNow(true)" style="width:40px;">ðŸŽ¥</button>
        </div>
    </div>
    <div class="chat-area" id="flow"></div>
    <div class="input-bar">
        <input type="text" id="m-input" placeholder="Type a message">
        <button onclick="sendMsg()" style="width:60px;">âž¤</button>
    </div>
</div>

<div id="call-ui">
    <video id="remote-v" autoplay playsinline></video>
    <video id="local-v" autoplay playsinline muted></video>
    <div class="call-info">
        <h1 id="call-stat">Calling...</h1>
        <p id="peer-n"></p>
    </div>
    <div class="call-btns">
        <button onclick="killCall()" style="background:#ff3b30;" class="btn-call">âœ–</button>
        <button id="join-btn" onclick="answerCall()" style="background:#00a884; display:none;" class="btn-call">âœ”</button>
    </div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzxJmpSMoN6_CdXfUFymZ8CIOfllLv3PrEjWIo6IduIR_xHAsQ04vZpi8UIIyu4ON-9HQ/exec";
    let MY_N = localStorage.getItem('ps_name');
    let MY_ID = localStorage.getItem('ps_pin');
    let peer, localStream, activeCall;
    const ring = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3');
    ring.loop = true;

    window.onload = () => {
        if(!MY_N) document.getElementById('scr-reg').style.display='flex';
        else startSystem();
    };

    function startSystem() {
        document.getElementById('scr-reg').style.display='none';
        document.getElementById('main-app').classList.add('active');
        document.getElementById('u-name').innerText = MY_N;
        document.getElementById('u-id').innerText = "ID: " + MY_ID;

        // Optimized Peer Config
        peer = new Peer(MY_ID, {
            config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]}
        });
        
        peer.on('call', call => {
            activeCall = call;
            ring.play();
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-stat').innerText = "INCOMING CALL";
            document.getElementById('peer-n').innerText = call.metadata.name || "Unknown";
            document.getElementById('join-btn').style.display = 'flex';
            // Voice call ke liye local video hide karna
            document.getElementById('local-v').style.display = call.metadata.video ? 'block' : 'none';
        });

        // Message Sync Logic (Unaltered)
        setInterval(async () => {
            try {
                const res = await fetch(`${API}?pin=${MY_ID}`);
                const data = await res.json();
                data.forEach(m => { if(m.type==='chat') render(m.message, 'received'); });
            } catch(e) {}
        }, 1500);
    }

    async function initAccount() {
        let n = document.getElementById('reg-name').value;
        if(!n) return;
        const res = await fetch(`${API}?action=getPin`);
        const id = await res.text();
        localStorage.setItem('ps_name', n);
        localStorage.setItem('ps_pin', id);
        location.reload();
    }

    async function callNow(isVid) {
        let tid = document.getElementById('t-id').value;
        if(!tid) return alert("Enter Target ID");
        
        document.getElementById('call-ui').style.display = 'flex';
        document.getElementById('call-stat').innerText = isVid ? "VIDEO CALLING..." : "VOICE CALLING...";
        
        try {
            // FIX: Agar isVid false hai, toh video mangega hi nahi
            localStream = await navigator.mediaDevices.getUserMedia({video: isVid, audio: true});
            
            if(isVid) {
                document.getElementById('local-v').srcObject = localStream;
                document.getElementById('local-v').style.display = 'block';
            } else {
                document.getElementById('local-v').style.display = 'none';
            }
            
            const call = peer.call(tid, localStream, {metadata: {name: MY_N, video: isVid}});
            bindStream(call);
        } catch(e) { 
            console.error(e);
            alert("Mic/Camera Access Required!");
            killCall(); 
        }
    }

    async function answerCall() {
        ring.pause();
        document.getElementById('join-btn').style.display = 'none';
        const vidRequired = activeCall.metadata.video;
        
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: vidRequired, audio: true});
            if(vidRequired) {
                document.getElementById('local-v').srcObject = localStream;
                document.getElementById('local-v').style.display = 'block';
            } else {
                document.getElementById('local-v').style.display = 'none';
            }
            activeCall.answer(localStream);
            bindStream(activeCall);
        } catch(e) {
            alert("Cannot Answer: Mic/Camera error");
            killCall();
        }
    }

    function bindStream(call) {
        activeCall = call;
        call.on('stream', s => {
            document.getElementById('remote-v').srcObject = s;
            document.getElementById('call-stat').innerText = "CONNECTED";
        });
        call.on('close', killCall);
        call.on('error', killCall);
    }

    function killCall() {
        if(localStream) {
            localStream.getTracks().forEach(t => t.stop());
        }
        ring.pause();
        document.getElementById('call-ui').style.display = 'none';
        // Reload is heavy, just resetting UI
        document.getElementById('remote-v').srcObject = null;
    }

    function sendMsg() {
        let m = document.getElementById('m-input').value;
        let t = document.getElementById('t-id').value;
        if(!m || !t) return;
        render(m, 'sent');
        document.getElementById('m-input').value = "";
        // Sending through Sheet (Unaltered)
        fetch(API, {method: 'POST', mode: 'no-cors', body: JSON.stringify({sender:MY_ID, receiver:t, message:m, type:'chat', name:MY_N})});
    }

    function render(txt, side) {
        const d = document.createElement('div');
        d.className = `msg ${side}`;
        d.innerText = txt;
        const box = document.getElementById('flow');
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
