<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Elite v400 | Force Connect</title>
    <style>
        :root { --neon: #00f2ff; --bg: #000; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .box { background: #0d0d0d; border: 1px solid #1a1a1a; padding: 30px; width: 100%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: var(--neon); text-align: center; outline: none; }
        button { width: 100%; padding: 15px; background: var(--neon); border: none; font-weight: bold; cursor: pointer; }
        #log { position: fixed; bottom: 0; width: 100%; background: rgba(255,0,0,0.1); color: #ff4444; font-size: 10px; padding: 5px; max-height: 50px; overflow: auto; }
        
        /* Chat UI */
        #chat-win { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; background: #000; width: 100%; }
        .msg { padding: 10px 15px; border-radius: 4px; max-width: 80%; font-size: 14px; }
        .s { align-self: flex-end; background: var(--neon); color: #000; }
        .r { align-self: flex-start; background: #1a1a1a; border: 1px solid #333; }
    </style>
</head>
<body>

    <div id="log">System Ready... Waiting for connection.</div>

    <div id="scr-reg" class="screen">
        <div class="box">
            <h1 style="color:var(--neon); letter-spacing:3px;">NODE 400</h1>
            <input type="text" id="reg-name" placeholder="YOUR NAME">
            <button onclick="start()">ACTIVATE</button>
        </div>
    </div>

    <div id="scr-dash" class="screen hidden">
        <div class="box">
            <h1 id="my-pin" style="font-size:40px; color:var(--neon);">000000</h1>
            <input type="number" id="t-pin" placeholder="TARGET PIN">
            <button onclick="connect()">CONNECT PEER</button>
        </div>
    </div>

    <div id="scr-chat" class="screen hidden" style="justify-content: flex-start; padding: 0;">
        <div style="width:100%; padding:15px; background:#0d0d0d; border-bottom:1px solid #1a1a1a; display:flex; justify-content:space-between;">
            <span onclick="location.reload()">[EXIT]</span>
            <b id="p-name">PEER</b>
            <span onclick="alert('Calls need HTTPS to work!')" style="color:var(--neon)">CALL</span>
        </div>
        <div id="chat-win"></div>
        <div style="width:100%; padding:10px; background:#0d0d0d; display:flex; gap:5px;">
            <input type="text" id="msg-in" style="margin:0;" placeholder="TYPE...">
            <button onclick="send()" style="width:70px;">SEND</button>
        </div>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let me = null, peer = null, db = {}, busy = false;

    function debug(m) { document.getElementById('log').innerText = m; }

    function start() {
        let n = document.getElementById('reg-name').value;
        if(!n) return;
        me = { name: n, pin: Math.floor(100000 + Math.random() * 900000).toString() };
        document.getElementById('scr-reg').classList.add('hidden');
        document.getElementById('scr-dash').classList.remove('hidden');
        document.getElementById('my-pin').innerText = me.pin;
        
        // Registering to Google
        ping(`action=register&name=${n}&pin=${me.pin}`);
        setInterval(sync, 2000);
    }

    function ping(p, cb) {
        debug("Pinging Server...");
        const s = document.createElement('script');
        s.src = `${API_URL}?${p}&_cache=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onerror = () => debug("NETWORK ERROR: Check Internet or Hosting!");
        s.onload = () => s.remove();
    }

    function connect() {
        let p = document.getElementById('t-pin').value;
        ping(`action=getUser&pin=${p}`, "onPeer");
    }

    window.onPeer = (r) => { if(r.name) openChat(r.name, r.pin); else debug("Peer Not Found!"); };

    function openChat(n, p) {
        peer = { name: n, pin: p };
        document.getElementById('scr-dash').classList.add('hidden');
        document.getElementById('scr-chat').classList.remove('hidden');
        document.getElementById('p-name').innerText = n;
        render();
    }

    function render() {
        const w = document.getElementById('chat-win');
        w.innerHTML = "";
        (db[peer.pin] || []).forEach(m => {
            w.innerHTML += `<div class="msg ${m.f === me.pin ? 's' : 'r'}">${m.v}</div>`;
        });
        w.scrollTop = w.scrollHeight;
    }

    function send() {
        let v = document.getElementById('msg-in').value;
        if(!v || !peer) return;
        if(!db[peer.pin]) db[peer.pin] = [];
        db[peer.pin].push({ f: me.pin, v: v });
        render();
        document.getElementById('msg-in').value = "";
        ping(`action=send&from=${me.pin}&from_name=${me.name}&to=${peer.pin}&msg=${encodeURIComponent(v)}`);
    }

    function sync() {
        if(!me || busy) return;
        busy = true;
        ping(`action=getMessages&myPin=${me.pin}`, "onSync");
    }

    window.onSync = (data) => {
        busy = false;
        debug("Connected. Watching for signals...");
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!db[m.sender]) db[m.sender] = [];
                if(!db[m.sender].some(x => x.v === m.txt)) {
                    db[m.sender].push({ f: m.sender, v: m.txt });
                    // AUTO OPEN CHAT
                    if(!peer || peer.pin !== m.sender) openChat(m.sender_name, m.sender);
                }
            });
            render();
        }
    }
</script>
</body>
</html>
