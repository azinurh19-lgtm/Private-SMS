<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Private Elite Pro v22</title>
    <style>
        :root { 
            --bg-deep: #080a0c; 
            --accent-neon: #00f2ff; 
            --panel-glass: rgba(18, 22, 25, 0.98); 
            --sent-gradient: linear-gradient(135deg, #0088ff, #00ccff);
            --recv-bg: #1e252b; 
            --text-bright: #ffffff;
            --text-dim: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-deep); color: var(--text-bright); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Premium Animations */
        @keyframes flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Setup & Main UI */
        #setup-page, #main-ui { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; }
        .premium-card { background: var(--panel-glass); padding: 40px 30px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.05); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .premium-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0,242,255,0.05) 0%, transparent 70%); pointer-events: none; }

        .input-style { background: #161b21; border: 1px solid #2d3748; padding: 18px; border-radius: 16px; color: #fff; width: 100%; margin-bottom: 20px; outline: none; font-size: 16px; transition: 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
        .input-style:focus { border-color: var(--accent-neon); box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        
        .btn-action { background: var(--sent-gradient); color: #fff; font-weight: 700; border: none; cursor: pointer; border-radius: 16px; padding: 18px; width: 100%; font-size: 15px; letter-spacing: 1px; transition: 0.3s; }
        .btn-action:active { transform: scale(0.98); opacity: 0.9; }

        /* Chat Window */
        #chat-window { position: fixed; inset: 0; background: var(--bg-deep); z-index: 2000; display: flex; flex-direction: column; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .chat-header { background: var(--panel-glass); padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .profile-img { width: 45px; height: 45px; border-radius: 50%; background: var(--sent-gradient); display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #000; }
        
        .msg-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: radial-gradient(circle at top right, #0a0f14, #080a0c); }
        .msg { max-width: 75%; padding: 14px 18px; border-radius: 22px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s ease; }
        .sent { align-self: flex-end; background: var(--sent-gradient); color: #fff; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(0,136,255,0.3); }
        .recv { align-self: flex-start; background: var(--recv-bg); color: #fff; border-bottom-left-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .img-msg { width: 100%; border-radius: 15px; margin-bottom: 5px; }

        /* Calling System */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 80px 0; animation: popIn 0.3s ease; }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        #local-video { width: 110px; height: 160px; border-radius: 20px; position: absolute; top: 40px; right: 25px; border: 2px solid var(--accent-neon); z-index: 5001; object-fit: cover; }
        .call-user { position: relative; z-index: 5002; text-align: center; }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; background: var(--recv-bg); margin: 0 auto 20px; border: 3px solid var(--accent-neon); display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .call-btns { position: relative; z-index: 5002; display: flex; gap: 50px; }
        .c-btn { width: 75px; height: 75px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .end { background: #ff3b30; }
        .start { background: #00d946; }

        /* Footer */
        .chat-footer { padding: 15px 20px; background: var(--panel-glass); display: flex; align-items: center; gap: 15px; border-top: 1px solid rgba(255,255,255,0.05); }
        .msg-input-wrap { flex: 1; background: #1a2026; border-radius: 30px; padding: 5px 20px; display: flex; align-items: center; border: 1px solid #2d3748; }
        .msg-input-wrap input { flex: 1; background: transparent; border: none; color: #fff; padding: 12px 0; outline: none; font-size: 15px; }
        .send-btn { background: var(--sent-gradient); border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    </style>
</head>
<body>

    <audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="snd-ring" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

    <div id="setup-page">
        <div class="premium-card">
            <h1 style="font-size: 28px; margin-bottom: 10px; background: var(--sent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">PRIVATE ELITE</h1>
            <p style="color: var(--text-dim); margin-bottom: 35px; font-weight: 300;">Experience the Next Gen Privacy</p>
            <input type="text" id="user-name" class="input-style" placeholder="Your Name">
            <button class="btn-action" onclick="initApp()">GET STARTED</button>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <div class="premium-card">
            <div class="profile-img" id="my-init" style="width: 80px; height: 80px; font-size: 30px; margin: 0 auto 15px;">?</div>
            <h2 id="disp-name" style="margin-bottom: 5px;">User</h2>
            <p id="disp-pin" style="color: var(--accent-neon); margin-bottom: 30px; font-family: monospace; letter-spacing: 2px; font-size: 18px;">000000</p>
            <input type="number" id="target-pin" class="input-style" placeholder="Enter Friend's PIN">
            <button id="conn-btn" class="btn-action" onclick="connect()">ESTABLISH LINK</button>
        </div>
    </div>

    <div id="chat-window" class="hidden">
        <div class="chat-header">
            <div onclick="closeChat()" style="cursor:pointer; color: var(--accent-neon); font-size: 20px;">✕</div>
            <div class="profile-img" id="act-init" style="width: 40px; height: 40px;">?</div>
            <div style="flex:1">
                <b id="act-name" style="font-size: 17px; display: block;">Friend</b>
                <span style="font-size: 11px; color: #00d946;">● Encrypted Session</span>
            </div>
            <div style="display:flex; gap:20px;">
                <svg onclick="call('Video')" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-dim);"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                <svg onclick="call('Voice')" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-dim);"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </div>
        </div>
        <div class="msg-container" id="msgs"></div>
        <div class="chat-footer">
            <div class="msg-input-wrap">
                <svg onclick="document.getElementById('file').click()" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:10px; color: var(--text-dim); cursor:pointer;"><path d="M12 5v14M5 12h14"></path></svg>
                <input type="text" id="m-in" placeholder="Type something...">
                <input type="file" id="file" accept="image/*" class="hidden" onchange="sendFile(this)">
            </div>
            <button class="send-btn" onclick="sendMsg()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <div id="call-overlay" class="hidden">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-user">
            <div class="call-avatar" id="call-init">?</div>
            <h2 id="call-name" style="font-size: 35px; margin-bottom: 10px;">Friend</h2>
            <p id="call-status" style="color: var(--accent-neon); text-transform: uppercase; letter-spacing: 2px;">Connecting...</p>
        </div>
        <div class="call-btns">
            <button id="ans-btn" class="c-btn start hidden" onclick="answer()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.17-.24c1.05.42 2.19.64 3.39.64a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1c-9.39 0-17-7.61-17-17a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.2.22 2.34.64 3.39a1 1 0 0 1-.24 1.17l-2.2 2.2z"></path></svg>
            </button>
            <button class="c-btn end" onclick="hangup()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </button>
        </div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let userData = JSON.parse(localStorage.getItem('pe_v22_user')) || null;
    let chatHistory = JSON.parse(localStorage.getItem('pe_v22_chats')) || {};
    let targetPin = localStorage.getItem('pe_v22_target') || null;
    let stream = null;
    let mode = null;

    window.onload = () => {
        if(userData) launch();
        if("Notification" in window) Notification.requestPermission();
    };

    function initApp() {
        let name = document.getElementById('user-name').value.trim();
        if(!name) return;
        let pin = Math.floor(100000 + Math.random() * 900000).toString();
        userData = { name, pin };
        localStorage.setItem('pe_v22_user', JSON.stringify(userData));
        callAPI(`action=register&name=${encodeURIComponent(name)}&pin=${pin}`);
        launch();
    }

    function launch() {
        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        document.getElementById('disp-name').innerText = userData.name;
        document.getElementById('disp-pin').innerText = userData.pin;
        document.getElementById('my-init').innerText = userData.name.charAt(0);
        setInterval(sync, 1500);
    }

    function callAPI(params, cb) {
        const s = document.createElement('script');
        s.src = `${SCRIPT_URL}?${params}&_t=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    }

    function connect() {
        let pin = document.getElementById('target-pin').value;
        if(!pin) return;
        document.getElementById('conn-btn').innerText = "CONNECTING...";
        callAPI(`action=getUser&pin=${pin}`, "handleUser");
    }

    window.handleUser = (u) => {
        document.getElementById('conn-btn').innerText = "ESTABLISH LINK";
        if(u && u.name) {
            targetPin = u.pin;
            localStorage.setItem('pe_v22_target', u.pin);
            openChat(u.name, u.pin);
        } else alert("Link Failed: Incorrect PIN");
    }

    function openChat(name, pin) {
        targetPin = pin;
        document.getElementById('chat-window').classList.remove('hidden');
        document.getElementById('act-name').innerText = name;
        document.getElementById('act-init').innerText = name.charAt(0);
        renderMsgs();
    }

    function renderMsgs() {
        if(!targetPin) return;
        const box = document.getElementById('msgs'); box.innerHTML = "";
        (chatHistory[targetPin] || []).forEach(m => {
            if(m.type === 'system') return;
            const isImg = (m.text && m.text.startsWith('data:image'));
            const content = isImg ? `<img src="${m.text}" class="img-msg" onclick="window.open(this.src)">` : m.text;
            box.innerHTML += `<div class="msg ${m.sender == userData.pin ? 'sent' : 'recv'}">${content}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function sendMsg(val = null, type = 'text') {
        let t = val || document.getElementById('m-in').value;
        if(!t || !targetPin) return;
        if(!chatHistory[targetPin]) chatHistory[targetPin] = [];
        chatHistory[targetPin].push({ sender: userData.pin, text: t, type });
        localStorage.setItem('pe_v22_chats', JSON.stringify(chatHistory));
        renderMsgs();
        document.getElementById('m-in').value = "";
        callAPI(`action=send&from=${userData.pin}&from_name=${encodeURIComponent(userData.name)}&to=${targetPin}&msg=${encodeURIComponent(t)}`);
    }

    function sendFile(input) {
        if (input.files[0]) {
            let r = new FileReader();
            r.onload = (e) => sendMsg(e.target.result, 'image');
            r.readAsDataURL(input.files[0]);
        }
    }

    async function call(t) {
        mode = t;
        document.getElementById('call-overlay').classList.remove('hidden');
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-name').innerText = document.getElementById('act-name').innerText;
        document.getElementById('call-init').innerText = document.getElementById('act-init').innerText;
        document.getElementById('snd-ring').play();
        await setupMedia(t);
        sendMsg(`[CALL_REQ:${t}]`, 'system');
    }

    async function setupMedia(t) {
        try {
            if(stream) stream.getTracks().forEach(tr => tr.stop());
            stream = await navigator.mediaDevices.getUserMedia({ video: t === 'Video', audio: true });
            document.getElementById('local-video').srcObject = stream;
            document.getElementById('local-video').classList.toggle('hidden', t === 'Voice');
        } catch (e) { hangup(); }
    }

    function answer() {
        document.getElementById('snd-ring').pause();
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-status').innerText = "LIVE CONNECTION";
        setupMedia(mode).then(() => {
            document.getElementById('remote-video').srcObject = stream;
        });
    }

    function hangup() {
        document.getElementById('snd-ring').pause();
        if(stream) stream.getTracks().forEach(tr => tr.stop());
        document.getElementById('call-overlay').classList.add('hidden');
        sendMsg("[CALL_END]", 'system');
    }

    function sync() { 
        if(userData) callAPI(`action=getMessages&myPin=${userData.pin}`, "handleSync"); 
    }

    window.handleSync = (data) => {
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!chatHistory[m.sender]) chatHistory[m.sender] = [];
                if(!chatHistory[m.sender].some(x => x.text === m.text)) {
                    let isCall = m.text.includes("[CALL_REQ:");
                    let isImg = m.text.startsWith('data:image');
                    
                    chatHistory[m.sender].push({ sender: m.sender, text: m.text, type: isCall ? 'system' : 'text' });
                    
                    // UNLIMITED AUTO-CONNECT LOGIC
                    targetPin = m.sender;
                    localStorage.setItem('pe_v22_target', m.sender);

                    if(isCall) {
                        mode = m.text.includes("Video") ? "Video" : "Voice";
                        document.getElementById('call-overlay').classList.remove('hidden');
                        document.getElementById('ans-btn').classList.remove('hidden');
                        document.getElementById('call-name').innerText = m.sender_name;
                        document.getElementById('call-init').innerText = m.sender_name.charAt(0);
                        document.getElementById('call-status').innerText = `INCOMING ${mode} CALL`;
                        document.getElementById('snd-ring').play();
                    } else if(m.text === "[CALL_END]") {
                        hangup();
                    } else {
                        document.getElementById('snd-msg').play();
                        openChat(m.sender_name, m.sender); // Force redirect to chat on every message
                        if (Notification.permission === "granted") {
                            new Notification(m.sender_name, { body: isImg ? "Sent an image" : m.text });
                        }
                    }
                }
            });
            localStorage.setItem('pe_v22_chats', JSON.stringify(chatHistory));
            renderMsgs();
        }
    };

    function closeChat() { document.getElementById('chat-window').classList.add('hidden'); }
</script>
</body>
</html>
