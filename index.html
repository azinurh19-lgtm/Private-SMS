<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Ultra v32 | Zero-Limit</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --glass: rgba(10, 14, 20, 0.98);
            --neon: #00f2ff;
            --accent: linear-gradient(135deg, #00f2ff 0%, #7000ff 100%);
            --sent: #007aff;
            --recv: #1c252e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Outfit', sans-serif; background: #010409; color: #fff; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Page Layouts */
        .page { position: fixed; inset: 0; display: flex; flex-direction: column; z-index: 10; background: #010409; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(30px); border-radius: 40px; border: 1px solid rgba(255,255,255,0.08); padding: 40px; width: 92%; max-width: 420px; margin: auto; text-align: center; box-shadow: 0 40px 80px rgba(0,0,0,0.8); }

        /* Inputs & Buttons */
        .modern-input { width: 100%; background: #0d1117; border: 1px solid #30363d; padding: 20px; border-radius: 22px; color: #fff; font-size: 16px; margin-bottom: 22px; outline: none; transition: 0.3s; }
        .modern-input:focus { border-color: var(--neon); box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        .btn-glow { width: 100%; padding: 20px; border-radius: 22px; border: none; background: var(--accent); color: #fff; font-weight: 700; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 30px rgba(112, 0, 255, 0.4); }

        /* Chat UI */
        .chat-header { padding: 15px 20px; background: rgba(1, 4, 9, 0.98); border-bottom: 1px solid #21262d; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid #000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .msg-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; background: radial-gradient(circle at center, #0d1117 0%, #010409 100%); }
        .bubble { max-width: 80%; padding: 14px 18px; border-radius: 24px; font-size: 15.5px; line-height: 1.5; animation: pop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .sent { align-self: flex-end; background: var(--sent); border-bottom-right-radius: 4px; color: #fff; }
        .recv { align-self: flex-start; background: var(--recv); border-bottom-left-radius: 4px; border: 1px solid #30363d; }
        .bubble img { width: 100%; border-radius: 16px; margin-top: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        /* Call System Overlay */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #local-video { width: 130px; height: 190px; border-radius: 24px; position: absolute; top: 60px; right: 25px; border: 3px solid var(--neon); z-index: 100001; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .call-meta { z-index: 100002; text-align: center; }
        .call-btns { z-index: 100002; display: flex; gap: 60px; }
        .action-btn { width: 80px; height: 80px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .hangup { background: #ff3b30; box-shadow: 0 0 20px rgba(255,59,48,0.4); }
        .pickup { background: #34c759; box-shadow: 0 0 20px rgba(52,199,89,0.4); }

        .chat-footer { padding: 15px 20px; background: #0d1117; display: flex; gap: 12px; align-items: center; padding-bottom: 40px; }
        .input-box { flex: 1; background: #161b22; border-radius: 35px; display: flex; align-items: center; padding: 4px 18px; border: 1px solid #30363d; }
        .input-box input { flex: 1; background: none; border: none; padding: 14px; color: #fff; outline: none; font-size: 16px; }
    </style>
</head>
<body>

    <audio id="ring-tone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="msg-tone" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="p-reg" class="page">
        <div class="glass-panel">
            <h1 style="font-size: 40px; letter-spacing: -2px;">Elite<span style="color:var(--neon)">Ultra</span></h1>
            <p style="color: #8b949e; margin-bottom: 35px;">UNLIMITED ENCRYPTED NODE</p>
            <input type="text" id="user-name" class="modern-input" placeholder="Enter Identity">
            <button class="btn-glow" onclick="registerUser()">START LIFETIME SESSION</button>
        </div>
    </div>

    <div id="p-home" class="page hidden">
        <div class="glass-panel">
            <div class="avatar" id="my-av" style="width:100px; height:100px; font-size:45px; margin:0 auto 20px;">?</div>
            <h2 id="my-display-name">User</h2>
            <p id="my-display-pin" style="color: var(--neon); letter-spacing: 8px; font-size: 28px; margin: 15px 0 40px;">000000</p>
            <input type="number" id="peer-pin-input" class="modern-input" placeholder="Target Node PIN">
            <button class="btn-glow" onclick="connectToPeer()">LINK CONNECT</button>
        </div>
    </div>

    <div id="p-chat" class="page hidden">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div onclick="exitChat()" style="cursor:pointer; font-size: 20px; padding: 5px;">✕</div>
                <div class="avatar" id="peer-chat-av" style="width:42px; height:42px;">?</div>
                <div><b id="peer-chat-name">Friend</b><br><small style="color:#34c759">● Active Node</small></div>
            </div>
            <div style="display:flex; gap:22px;">
                <svg onclick="prepCall('Video')" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="var(--neon)" stroke-width="2" style="cursor:pointer"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                <svg onclick="prepCall('Voice')" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--neon)" stroke-width="2" style="cursor:pointer"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </div>
        </div>
        <div class="msg-flow" id="msg-render"></div>
        <div class="chat-footer">
            <div class="input-box">
                <svg onclick="document.getElementById('media-in').click()" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="2" style="cursor:pointer"><path d="M12 5v14M5 12h14"></path></svg>
                <input type="text" id="msg-input" placeholder="End-to-end encrypted...">
                <input type="file" id="media-in" class="hidden" accept="image/*" onchange="sendImage(this)">
            </div>
            <button class="avatar" style="width:52px; height:52px; border:none; cursor:pointer;" onclick="broadcastMsg()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <div id="call-overlay" class="hidden">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay playsinline muted></video>
        <div class="call-meta">
            <div class="avatar" id="call-scr-av" style="width:130px; height:130px; font-size:55px; margin:0 auto 25px; border:4px solid var(--neon);">?</div>
            <h1 id="call-scr-name" style="font-size:35px;">User</h1>
            <p id="call-scr-status" style="color:var(--neon); letter-spacing:4px; margin-top:12px; font-weight:600;">SIGNALING</p>
        </div>
        <div class="call-btns">
            <button id="btn-ans" class="action-btn pickup hidden" onclick="answerCall()">
                <svg width="38" height="38" viewBox="0 0 24 24" fill="#fff"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.17-.24c1.05.42 2.19.64 3.39.64a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1c-9.39 0-17-7.61-17-17a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.2.22 2.34.64 3.39a1 1 0 0 1-.24 1.17l-2.2 2.2z"></path></svg>
            </button>
            <button class="action-btn hangup" onclick="killCall()">
                <svg width="38" height="38" viewBox="0 0 24 24" fill="#fff"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </button>
        </div>
    </div>

<script>
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let userData = JSON.parse(localStorage.getItem('ultra_v32_user')) || null;
    let localDB = JSON.parse(localStorage.getItem('ultra_v32_db')) || {};
    let activePeer = null;
    let mediaStream = null;
    let cType = null;
    let lock = false;

    window.onload = () => {
        if(userData) startApp();
        document.getElementById('msg-input').onkeydown = (e) => e.key === 'Enter' && broadcastMsg();
    };

    function registerUser() {
        let name = document.getElementById('user-name').value.trim();
        if(!name) return;
        let pin = Math.floor(100000 + Math.random() * 900000).toString();
        userData = { name, pin };
        localStorage.setItem('ultra_v32_user', JSON.stringify(userData));
        serverSync(`action=register&name=${encodeURIComponent(name)}&pin=${pin}`);
        startApp();
    }

    function startApp() {
        document.getElementById('p-reg').classList.add('hidden');
        document.getElementById('p-home').classList.remove('hidden');
        document.getElementById('my-display-name').innerText = userData.name;
        document.getElementById('my-display-pin').innerText = userData.pin;
        document.getElementById('my-av').innerText = userData.name[0].toUpperCase();
        setInterval(coreSync, 1000);
    }

    function serverSync(p, cb) {
        const s = document.createElement('script');
        s.src = `${ENDPOINT}?${p}&_t=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    }

    function connectToPeer() {
        let pin = document.getElementById('peer-pin-input').value;
        if(!pin) return;
        serverSync(`action=getUser&pin=${pin}`, "onPeerResult");
    }

    window.onPeerResult = (u) => {
        if(u && u.name) initChat(u.name, u.pin);
        else alert("Node not found!");
    };

    function initChat(name, pin) {
        activePeer = pin;
        document.getElementById('p-home').classList.add('hidden');
        document.getElementById('p-chat').classList.remove('hidden');
        document.getElementById('peer-chat-name').innerText = name;
        document.getElementById('peer-chat-av').innerText = name[0].toUpperCase();
        updateUI();
    }

    function updateUI() {
        if(!activePeer) return;
        const screen = document.getElementById('msg-render');
        screen.innerHTML = "";
        (localDB[activePeer] || []).forEach(m => {
            if(m.sig) return;
            const isImg = m.val.startsWith('data:image');
            screen.innerHTML += `<div class="bubble ${m.from === userData.pin ? 'sent' : 'recv'}">
                ${isImg ? `<img src="${m.val}">` : m.val}
            </div>`;
        });
        screen.scrollTop = screen.scrollHeight;
    }

    function broadcastMsg(val = null, isSig = false) {
        let txt = val || document.getElementById('msg-input').value.trim();
        if(!txt || !activePeer) return;

        if(!localDB[activePeer]) localDB[activePeer] = [];
        localDB[activePeer].push({ from: userData.pin, val: txt, sig: isSig });
        localStorage.setItem('ultra_v32_db', JSON.stringify(localDB));
        
        if(!isSig) {
            updateUI();
            document.getElementById('msg-input').value = "";
        }
        serverSync(`action=send&from=${userData.pin}&from_name=${encodeURIComponent(userData.name)}&to=${activePeer}&msg=${encodeURIComponent(txt)}`);
    }

    function sendImage(el) {
        if(el.files[0]) {
            let r = new FileReader();
            r.onload = (e) => broadcastMsg(e.target.result);
            r.readAsDataURL(el.files[0]);
        }
    }

    async function prepCall(type) {
        cType = type;
        document.getElementById('call-overlay').classList.remove('hidden');
        document.getElementById('call-scr-name').innerText = document.getElementById('peer-chat-name').innerText;
        document.getElementById('call-scr-av').innerText = document.getElementById('peer-chat-av').innerText;
        document.getElementById('ring-tone').play();
        await streamOn(type);
        broadcastMsg(`[CALL_REQ:${type}]`, true);
    }

    async function streamOn(type) {
        try {
            if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: type === 'Video', audio: true });
            document.getElementById('local-v').srcObject = mediaStream;
            document.getElementById('local-v').classList.toggle('hidden', type === 'Voice');
        } catch(e) { killCall(); }
    }

    function answerCall() {
        document.getElementById('ring-tone').pause();
        document.getElementById('btn-ans').classList.add('hidden');
        document.getElementById('call-scr-status').innerText = "LIVE NODE CONNECTED";
        streamOn(cType).then(() => {
            document.getElementById('remote-v').srcObject = mediaStream;
        });
    }

    function killCall() {
        document.getElementById('ring-tone').pause();
        if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-overlay').classList.add('hidden');
        if(activePeer) serverSync(`action=send&from=${userData.pin}&from_name=${encodeURIComponent(userData.name)}&to=${activePeer}&msg=[CALL_END]`);
    }

    function coreSync() {
        if(!userData || lock) return;
        lock = true;
        serverSync(`action=getMessages&myPin=${userData.pin}`, "onGlobalSync");
    }

    window.onGlobalSync = (data) => {
        lock = false;
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!localDB[m.sender]) localDB[m.sender] = [];
                if(!localDB[m.sender].some(x => x.val === m.txt)) {
                    
                    let isCall = m.txt.includes("[CALL_REQ:");
                    let isEnd = m.txt === "[CALL_END]";
                    
                    localDB[m.sender].push({ from: m.sender, val: m.txt, sig: isCall || isEnd });

                    if(isCall) {
                        cType = m.txt.includes("Video") ? "Video" : "Voice";
                        document.getElementById('call-overlay').classList.remove('hidden');
                        document.getElementById('btn-ans').classList.remove('hidden');
                        document.getElementById('call-scr-name').innerText = m.sender_name;
                        document.getElementById('call-scr-status').innerText = `INCOMING ${cType.toUpperCase()}`;
                        document.getElementById('ring-tone').play();
                    } else if(isEnd) {
                        killCall();
                    } else {
                        document.getElementById('msg-tone').play();
                        // AUTO-OPEN CHAT LOGIC (Always Wake)
                        if(activePeer !== m.sender) {
                            initChat(m.sender_name, m.sender);
                        }
                    }
                }
            });
            localStorage.setItem('ultra_v32_db', JSON.stringify(localDB));
            updateUI();
        }
    };

    function exitChat() {
        document.getElementById('p-chat').classList.add('hidden');
        document.getElementById('p-home').classList.remove('hidden');
        activePeer = null;
    }
</script>
</body>
</html>
