<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Ultra Pro Max v28</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --glass-bg: rgba(13, 17, 23, 0.98);
            --neon-blue: #00f2ff;
            --neon-purple: #7000ff;
            --accent: linear-gradient(135deg, #00f2ff 0%, #7000ff 100%);
            --sent: #007aff;
            --recv: #232d36;
            --text: #ffffff;
            --dim: #94a3b8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Outfit', sans-serif; background: #010409; color: var(--text); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Full Screen Layouts */
        .page { position: fixed; inset: 0; display: flex; flex-direction: column; z-index: 10; background: #010409; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); padding: 30px; width: 90%; max-width: 400px; margin: auto; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.9); }

        /* Advanced Inputs */
        .modern-input { width: 100%; background: #0d1117; border: 1px solid #30363d; padding: 18px; border-radius: 18px; color: #fff; font-size: 16px; margin-bottom: 20px; outline: none; transition: 0.3s; }
        .modern-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .btn-glow { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--accent); color: #fff; font-weight: 700; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 30px rgba(112, 0, 255, 0.3); }

        /* Chat System */
        .chat-header { padding: 15px 20px; background: rgba(1, 4, 9, 0.9); border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #000; }

        .msg-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: radial-gradient(circle at top, #0d1117, #010409); }
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; animation: slideIn 0.2s ease-out; word-wrap: break-word; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bubble.sent { align-self: flex-end; background: var(--sent); border-bottom-right-radius: 4px; }
        .bubble.recv { align-self: flex-start; background: var(--recv); border-bottom-left-radius: 4px; }
        .bubble img { width: 100%; border-radius: 12px; margin-top: 5px; display: block; }

        /* Call Overlay */
        #call-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #local-video { width: 110px; height: 160px; border-radius: 15px; top: 40px; right: 20px; border: 2px solid var(--neon-blue); z-index: 5001; }
        .call-meta { z-index: 5002; text-align: center; }
        .call-ctrl { z-index: 5002; display: flex; gap: 40px; }
        .btn-round { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .hangup { background: #ff3b30; }
        .accept { background: #34c759; }

        /* Footer */
        .chat-footer { padding: 15px 20px; background: #0d1117; display: flex; align-items: center; gap: 10px; padding-bottom: 30px; }
        .input-wrap { flex: 1; background: #161b22; border-radius: 25px; display: flex; align-items: center; padding: 0 15px; border: 1px solid #30363d; }
        .input-wrap input { flex: 1; background: none; border: none; padding: 12px; color: #fff; outline: none; }
        .icon-btn { background: var(--accent); width: 45px; height: 45px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="ring-tone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="msg-tone" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="page-reg" class="page">
        <div class="glass-panel">
            <h1 style="font-size: 32px; background: var(--accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Elite Ultra</h1>
            <p style="color: var(--dim); margin-bottom: 30px;">SECURE NODE ENCRYPTION</p>
            <input type="text" id="reg-name" class="modern-input" placeholder="Enter Identity">
            <button class="btn-glow" onclick="setupUser()">INITIALIZE</button>
        </div>
    </div>

    <div id="page-home" class="page hidden">
        <div class="glass-panel">
            <div class="avatar" id="my-av" style="width: 80px; height: 80px; font-size: 30px; margin: 0 auto 15px;">?</div>
            <h2 id="my-name">User</h2>
            <p id="my-pin" style="color: var(--neon-blue); letter-spacing: 5px; font-size: 24px; margin: 10px 0 30px;">000000</p>
            <input type="number" id="peer-pin" class="modern-input" placeholder="Target Node PIN">
            <button class="btn-glow" onclick="findPeer()">LINK CONNECT</button>
        </div>
    </div>

    <div id="page-chat" class="page hidden">
        <div class="chat-header">
            <div class="user-info">
                <div onclick="goHome()" style="cursor:pointer; margin-right: 10px;">✕</div>
                <div class="avatar" id="chat-av" style="width: 40px; height: 40px;">?</div>
                <div>
                    <b id="chat-name">Target</b><br>
                    <small style="color:#34c759">● ENCRYPTED</small>
                </div>
            </div>
            <div style="display:flex; gap:15px;">
                <button onclick="makeCall('Video')" style="background:none; border:none;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
                <button onclick="makeCall('Voice')" style="background:none; border:none;"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></button>
            </div>
        </div>
        <div class="msg-flow" id="msg-screen"></div>
        <div class="chat-footer">
            <div class="input-wrap">
                <svg onclick="document.getElementById('file-in').click()" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" style="cursor:pointer"><path d="M12 5v14M5 12h14"></path></svg>
                <input type="text" id="chat-input" placeholder="Message...">
                <input type="file" id="file-in" class="hidden" accept="image/*" onchange="sendPhoto(this)">
            </div>
            <button class="icon-btn" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <div id="call-screen" class="hidden">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-meta">
            <div class="avatar" id="call-av" style="width:120px; height:120px; font-size:50px; margin:0 auto 20px; border:4px solid var(--neon-blue);">?</div>
            <h2 id="call-peer-name">Peer</h2>
            <p id="call-status" style="color:var(--neon-blue); margin-top:10px;">SIGNALING...</p>
        </div>
        <div class="call-ctrl">
            <button id="ans-btn" class="btn-round accept hidden" onclick="answerCall()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.17-.24c1.05.42 2.19.64 3.39.64a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1c-9.39 0-17-7.61-17-17a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.2.22 2.34.64 3.39a1 1 0 0 1-.24 1.17l-2.2 2.2z"></path></svg>
            </button>
            <button class="btn-round hangup" onclick="endCall()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="#fff"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </button>
        </div>
    </div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let myData = JSON.parse(localStorage.getItem('elite_v28_user')) || null;
    let db = JSON.parse(localStorage.getItem('elite_v28_db')) || {};
    let targetPin = null;
    let stream = null;
    let callType = null;
    let syncLock = false;

    window.onload = () => {
        if(myData) startApp();
        // Support Enter key
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    };

    function setupUser() {
        let n = document.getElementById('reg-name').value.trim();
        if(!n) return;
        let p = Math.floor(100000 + Math.random() * 900000).toString();
        myData = { name: n, pin: p };
        localStorage.setItem('elite_v28_user', JSON.stringify(myData));
        fetchAPI(`action=register&name=${encodeURIComponent(n)}&pin=${p}`);
        startApp();
    }

    function startApp() {
        document.getElementById('page-reg').classList.add('hidden');
        document.getElementById('page-home').classList.remove('hidden');
        document.getElementById('my-name').innerText = myData.name;
        document.getElementById('my-pin').innerText = myData.pin;
        document.getElementById('my-av').innerText = myData.name.charAt(0).toUpperCase();
        setInterval(syncCore, 1000); // Stable 1s sync
    }

    function fetchAPI(params, cb) {
        const s = document.createElement('script');
        s.src = `${API}?${params}&_t=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    }

    function findPeer() {
        let p = document.getElementById('peer-pin').value;
        if(!p) return;
        fetchAPI(`action=getUser&pin=${p}`, "onPeerFound");
    }

    window.onPeerFound = (u) => {
        if(u && u.name) {
            openChat(u.name, u.pin);
        } else alert("Invalid PIN");
    }

    function openChat(name, pin) {
        targetPin = pin;
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-chat').classList.remove('hidden');
        document.getElementById('chat-name').innerText = name;
        document.getElementById('chat-av').innerText = name.charAt(0).toUpperCase();
        renderMessages();
    }

    function renderMessages() {
        if(!targetPin) return;
        const box = document.getElementById('msg-screen');
        box.innerHTML = "";
        (db[targetPin] || []).forEach(m => {
            if(m.type === 'call') return;
            const isImg = m.text.startsWith('data:image');
            const content = isImg ? `<img src="${m.text}">` : m.text;
            box.innerHTML += `<div class="bubble ${m.sender === myData.pin ? 'sent' : 'recv'}">${content}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage(content = null) {
        let t = content || document.getElementById('chat-input').value.trim();
        if(!t || !targetPin) return;
        
        if(!db[targetPin]) db[targetPin] = [];
        db[targetPin].push({ sender: myData.pin, text: t, time: Date.now() });
        localStorage.setItem('elite_v28_db', JSON.stringify(db));
        
        renderMessages();
        document.getElementById('chat-input').value = "";
        fetchAPI(`action=send&from=${myData.pin}&from_name=${encodeURIComponent(myData.name)}&to=${targetPin}&msg=${encodeURIComponent(t)}`);
    }

    function sendPhoto(el) {
        if(el.files[0]) {
            let r = new FileReader();
            r.onload = (e) => sendMessage(e.target.result);
            r.readAsDataURL(el.files[0]);
        }
    }

    async function makeCall(type) {
        callType = type;
        document.getElementById('call-screen').classList.remove('hidden');
        document.getElementById('call-peer-name').innerText = document.getElementById('chat-name').innerText;
        document.getElementById('call-av').innerText = document.getElementById('chat-av').innerText;
        document.getElementById('ring-tone').play();
        await initMedia(type);
        sendMessage(`[CALL_SIGNAL:${type}]`); // Special Call Signal
    }

    async function initMedia(type) {
        try {
            if(stream) stream.getTracks().forEach(t => t.stop());
            stream = await navigator.mediaDevices.getUserMedia({ video: type === 'Video', audio: true });
            document.getElementById('local-video').srcObject = stream;
            document.getElementById('local-video').classList.toggle('hidden', type === 'Voice');
        } catch(e) { endCall(); }
    }

    function answerCall() {
        document.getElementById('ring-tone').pause();
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-status').innerText = "LIVE CONNECTION";
        initMedia(callType).then(() => {
            document.getElementById('remote-video').srcObject = stream;
        });
    }

    function endCall() {
        document.getElementById('ring-tone').pause();
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('call-screen').classList.add('hidden');
        sendMessage("[CALL_TERMINATE]");
    }

    function syncCore() {
        if(!myData || syncLock) return;
        syncLock = true;
        fetchAPI(`action=getMessages&myPin=${myData.pin}`, "onSync");
    }

    window.onSync = (data) => {
        syncLock = false;
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!db[m.sender]) db[m.sender] = [];
                // Duplicate message check using timestamp or content
                if(!db[m.sender].some(x => x.text === m.text)) {
                    
                    let isCall = m.text.includes("[CALL_SIGNAL:");
                    let isEnd = m.text === "[CALL_TERMINATE]";
                    
                    db[m.sender].push({ sender: m.sender, text: m.text, time: Date.now() });

                    if(isCall) {
                        callType = m.text.includes("Video") ? "Video" : "Voice";
                        document.getElementById('call-screen').classList.remove('hidden');
                        document.getElementById('ans-btn').classList.remove('hidden');
                        document.getElementById('call-peer-name').innerText = m.sender_name;
                        document.getElementById('call-av').innerText = m.sender_name.charAt(0);
                        document.getElementById('call-status').innerText = `INCOMING ${callType}`;
                        document.getElementById('ring-tone').play();
                    } else if(isEnd) {
                        endCall();
                    } else {
                        document.getElementById('msg-tone').play();
                        // AUTO-OPEN CHAT LOGIC
                        if(targetPin !== m.sender) {
                            openChat(m.sender_name, m.sender);
                        }
                    }
                }
            });
            localStorage.setItem('elite_v28_db', JSON.stringify(db));
            renderMessages();
        }
    }

    function goHome() {
        document.getElementById('page-chat').classList.add('hidden');
        document.getElementById('page-home').classList.remove('hidden');
        targetPin = null;
    }
</script>
</body>
</html>
