<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite v55 | Unlimited Node</title>
    <style>
        :root { --neon: #00f2ff; --bg: #000000; --panel: #0d0d0d; --border: #1a1a1a; --sent: #00f2ff; --received: #1a1a1a; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; width: 100vw; overflow: hidden; position: fixed; }
        .hidden { display: none !important; }

        /* Full Screen Transitions */
        .page { position: fixed; inset: 0; display: flex; flex-direction: column; background: var(--bg); z-index: 100; }
        .center-box { display: flex; align-items: center; justify-content: center; height: 100%; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 40px; width: 90%; max-width: 400px; border-radius: 8px; text-align: center; }
        
        /* Hardware UI Elements */
        h1 { font-size: 22px; font-weight: 200; letter-spacing: 8px; color: var(--neon); margin-bottom: 30px; }
        .input-node { width: 100%; background: #000; border: 1px solid var(--border); padding: 18px; color: var(--neon); font-size: 16px; margin-bottom: 20px; outline: none; text-align: center; border-radius: 4px; }
        .btn-node { width: 100%; padding: 18px; border: none; background: var(--neon); color: #000; font-weight: 800; cursor: pointer; text-transform: uppercase; border-radius: 4px; letter-spacing: 2px; }

        /* Messaging Interface */
        .top-nav { padding: 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .peer-info { display: flex; align-items: center; gap: 12px; }
        .peer-avatar { width: 40px; height: 40px; border: 1px solid var(--neon); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--neon); border-radius: 50%; }
        
        .chat-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #000; }
        .bubble { max-width: 80%; padding: 12px 16px; font-size: 15px; border-radius: 4px; line-height: 1.4; }
        .bubble.s { align-self: flex-end; background: var(--neon); color: #000; font-weight: 500; }
        .bubble.r { align-self: flex-start; background: var(--panel); border: 1px solid var(--border); color: #fff; }

        .input-strip { padding: 20px; background: var(--panel); border-top: 1px solid var(--border); display: flex; gap: 10px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        .chat-input { flex: 1; background: #000; border: 1px solid var(--border); padding: 15px; color: #fff; outline: none; border-radius: 4px; }
        .btn-send { background: var(--neon); border: none; padding: 0 20px; border-radius: 4px; font-weight: 900; color: #000; cursor: pointer; }

        /* Call Overlay Engine */
        #call-ui { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        .vid-frame { flex: 1; position: relative; background: #050505; overflow: hidden; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { width: 100px; height: 150px; position: absolute; top: 20px; right: 20px; border: 1px solid var(--neon); object-fit: cover; z-index: 10; }
        
        .call-meta { position: absolute; top: 15%; width: 100%; text-align: center; }
        .call-meta h2 { font-size: 32px; font-weight: 300; margin-bottom: 10px; }
        .call-meta p { color: var(--neon); letter-spacing: 4px; font-size: 12px; }

        .call-actions { padding: 50px; display: flex; justify-content: center; gap: 40px; position: absolute; bottom: 0; width: 100%; }
        .c-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-accept { background: #2ecc71; color: #fff; }
        .btn-hang { background: #e74c3c; color: #fff; }
    </style>
</head>
<body>

    <audio id="ring-sfx" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="msg-sfx" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div id="pg-reg" class="page">
        <div class="center-box">
            <div class="card">
                <h1>ELITE NODE</h1>
                <input type="text" id="reg-name" class="input-node" placeholder="NODE NAME">
                <button class="btn-node" onclick="reg()">ACTIVATE</button>
            </div>
        </div>
    </div>

    <div id="pg-dash" class="page hidden">
        <div class="center-box">
            <div class="card">
                <p style="color:#555; font-size:10px; margin-bottom:10px;">IDENTITY ACTIVE</p>
                <h2 id="my-name" style="font-weight:200; margin-bottom:20px;">USER</h2>
                <div style="background:#000; padding:20px; border:1px solid #1a1a1a; margin-bottom:30px;">
                    <p style="color:#555; font-size:10px; margin-bottom:5px;">SYSTEM PIN</p>
                    <h1 id="my-pin" style="margin:0; font-size:35px;">000000</h1>
                </div>
                <input type="number" id="peer-pin" class="input-node" placeholder="PEER PIN">
                <button class="btn-node" onclick="connect()">ESTABLISH LINK</button>
            </div>
        </div>
    </div>

    <div id="pg-chat" class="page hidden">
        <div class="top-nav">
            <div class="peer-info">
                <div onclick="goHome()" style="cursor:pointer; margin-right:10px;">BACK</div>
                <div class="peer-avatar" id="p-av">?</div>
                <div><b id="p-name">PEER</b><br><small style="color:#2ecc71">ENCRYPTED</small></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="scall('Video')" style="background:none; border:1px solid var(--neon); color:var(--neon); padding:6px 12px; font-size:11px;">VIDEO</button>
                <button onclick="scall('Voice')" style="background:none; border:1px solid var(--neon); color:var(--neon); padding:6px 12px; font-size:11px;">VOICE</button>
            </div>
        </div>
        <div class="chat-scroll" id="chat-box"></div>
        <div class="input-strip">
            <input type="text" id="chat-in" class="chat-input" placeholder="SECURE MESSAGE...">
            <button class="btn-send" onclick="send()">SEND</button>
        </div>
    </div>

    <div id="call-ui" class="hidden">
        <div class="vid-frame">
            <video id="remote-v" autoplay playsinline></video>
            <video id="local-v" autoplay playsinline muted></video>
        </div>
        <div class="call-meta">
            <h2 id="c-peer">PEER NODE</h2>
            <p id="c-status">LINKING...</p>
        </div>
        <div class="call-actions">
            <button id="c-accept" class="c-btn btn-accept" onclick="ans()">ACCEPT</button>
            <button class="c-btn btn-hang" onclick="hang()">END</button>
        </div>
    </div>

<script>
    // FIXED URL FOR 101% WORKING
    const S_URL = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    
    let me = JSON.parse(localStorage.getItem('node_me')) || null;
    let db = JSON.parse(localStorage.getItem('node_db')) || {};
    let target = null;
    let stream = null;
    let busy = false;
    let currentCallType = null;

    window.onload = () => { if(me) start(); };

    function reg() {
        let n = document.getElementById('reg-name').value.trim();
        if(!n) return;
        me = { name: n, pin: Math.floor(100000 + Math.random() * 900000).toString() };
        localStorage.setItem('node_me', JSON.stringify(me));
        api(`action=register&name=${encodeURIComponent(n)}&pin=${me.pin}`);
        start();
    }

    function start() {
        document.getElementById('pg-reg').classList.add('hidden');
        document.getElementById('pg-dash').classList.remove('hidden');
        document.getElementById('my-name').innerText = me.name;
        document.getElementById('my-pin').innerText = me.pin;
        setInterval(core, 1200); // High-Frequency Sync
    }

    function api(p, cb) {
        const s = document.createElement('script');
        s.src = `${S_URL}?${p}&_t=${Date.now()}${cb ? '&callback='+cb : ''}`;
        document.body.appendChild(s);
        s.onload = () => { s.remove(); busy = false; };
    }

    function connect() {
        let p = document.getElementById('peer-pin').value;
        if(!p) return;
        api(`action=getUser&pin=${p}`, "onL");
    }

    window.onL = (u) => { if(u && u.name) open(u.name, u.pin); else alert("NODE ERROR"); };

    function open(n, p) {
        target = p;
        document.getElementById('pg-dash').classList.add('hidden');
        document.getElementById('pg-chat').classList.remove('hidden');
        document.getElementById('p-name').innerText = n.toUpperCase();
        document.getElementById('p-av').innerText = n[0].toUpperCase();
        draw();
    }

    function draw() {
        if(!target) return;
        const b = document.getElementById('chat-box');
        b.innerHTML = "";
        (db[target] || []).forEach(m => {
            if(m.s) return;
            b.innerHTML += `<div class="bubble ${m.f === me.pin ? 's' : 'r'}">${m.v}</div>`;
        });
        b.scrollTop = b.scrollHeight;
    }

    function send(v = null, sig = false) {
        let val = v || document.getElementById('chat-in').value.trim();
        if(!val || !target) return;
        if(!db[target]) db[target] = [];
        db[target].push({ f: me.pin, v: val, s: sig });
        localStorage.setItem('node_db', JSON.stringify(db));
        if(!sig) { draw(); document.getElementById('chat-in').value = ""; }
        api(`action=send&from=${me.pin}&from_name=${encodeURIComponent(me.name)}&to=${target}&msg=${encodeURIComponent(val)}`);
    }

    // Call Engine
    async function scall(t) {
        currentCallType = t;
        document.getElementById('call-ui').classList.remove('hidden');
        document.getElementById('c-accept').classList.add('hidden');
        document.getElementById('c-peer').innerText = document.getElementById('p-name').innerText;
        document.getElementById('ring-sfx').play();
        await med(t);
        send(`[SIGNAL_CALL_${t}]`, true);
    }

    async function med(t) {
        try {
            if(stream) stream.getTracks().forEach(tr => tr.stop());
            stream = await navigator.mediaDevices.getUserMedia({ video: t === 'Video', audio: true });
            document.getElementById('local-v').srcObject = stream;
            document.getElementById('local-v').classList.toggle('hidden', t === 'Voice');
        } catch(e) { hang(); }
    }

    function ans() {
        document.getElementById('ring-sfx').pause();
        document.getElementById('c-accept').classList.add('hidden');
        document.getElementById('c-status').innerText = "LIVE SIGNAL";
        med(currentCallType).then(() => { document.getElementById('remote-v').srcObject = stream; });
    }

    function hang() {
        document.getElementById('ring-sfx').pause();
        if(stream) stream.getTracks().forEach(tr => tr.stop());
        document.getElementById('call-ui').classList.add('hidden');
        if(target) api(`action=send&from=${me.pin}&to=${target}&msg=[SIGNAL_END]`);
        currentCallType = null;
    }

    // --- THE UNLIMITED SYNC (WATCHDOG) ---
    function core() {
        if(!me || busy) return;
        busy = true;
        api(`action=getMessages&myPin=${me.pin}`, "onS");
    }

    window.onS = (data) => {
        busy = false;
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!db[m.sender]) db[m.sender] = [];
                // Exact Packet Check
                if(!db[m.sender].some(x => x.v === m.txt)) {
                    let isC = m.txt.includes("[SIGNAL_CALL_");
                    let isE = m.txt === "[SIGNAL_END]";
                    
                    db[m.sender].push({ f: m.sender, v: m.txt, s: isC || isE });

                    if(isC) {
                        currentCallType = m.txt.includes("Video") ? "Video" : "Voice";
                        target = m.sender;
                        document.getElementById('call-ui').classList.remove('hidden');
                        document.getElementById('c-accept').classList.remove('hidden');
                        document.getElementById('c-peer').innerText = m.sender_name;
                        document.getElementById('c-status').innerText = `INCOMING ${currentCallType.toUpperCase()}`;
                        document.getElementById('ring-sfx').play();
                    } else if(isE) {
                        hang();
                    } else {
                        // AUTO-WAKE LOGIC: Har message par chat open karega (No Limit)
                        document.getElementById('msg-sfx').play();
                        if(target !== m.sender) {
                            open(m.sender_name, m.sender);
                        }
                    }
                }
            });
            localStorage.setItem('node_db', JSON.stringify(db));
            draw();
        }
    }

    function goHome() {
        document.getElementById('pg-chat').classList.add('hidden');
        document.getElementById('pg-dash').classList.remove('hidden');
        target = null;
    }
</script>
</body>
</html>
