<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Elite Private v20 Pro</title>
    <style>
        :root { 
            --neon-green: #00ff41; 
            --dark-bg: #050505; 
            --panel-bg: #0f0f0f; 
            --sent-bg: #003b11; 
            --recv-bg: #1a1a1a; 
            --text-main: #ffffff;
            --text-dim: #888888;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--dark-bg); color: var(--text-main); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Cinematic Background Effect */
        body::before {
            content: ""; position: fixed; inset: 0;
            background: radial-gradient(circle at center, #003b11 0%, transparent 70%);
            opacity: 0.15; pointer-events: none; z-index: -1;
        }

        /* Professional Animations */
        @keyframes pulse-neon { 0% { box-shadow: 0 0 5px var(--neon-green); } 50% { box-shadow: 0 0 20px var(--neon-green); } 100% { box-shadow: 0 0 5px var(--neon-green); } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .neon-border { border: 1px solid var(--neon-green); animation: pulse-neon 2s infinite; }
        .connecting-text { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* Setup & Main UI */
        #setup-page, #main-ui { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .glass-card { background: rgba(15, 15, 15, 0.95); padding: 30px; border-radius: 24px; border: 1px solid #333; width: 100%; max-width: 380px; }
        .setup-input { background: #1a1a1a; border: 1px solid #333; padding: 18px; border-radius: 12px; color: #fff; width: 100%; margin-bottom: 20px; outline: none; font-size: 16px; transition: 0.3s; text-align: center; }
        .setup-input:focus { border-color: var(--neon-green); }
        .btn-prime { background: var(--neon-green); color: #000; font-weight: 800; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }

        /* Chat UI */
        #chat-window { position: fixed; inset: 0; background: var(--dark-bg); z-index: 2000; display: flex; flex-direction: column; animation: slideUp 0.4s cubic-bezier(0, 1, 0.5, 1); }
        .header { background: var(--panel-bg); padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #222; }
        .status-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; display: inline-block; box-shadow: 0 0 5px var(--neon-green); }
        .message-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; }
        .sent { align-self: flex-end; background: var(--sent-bg); color: #fff; border-bottom-right-radius: 2px; border: 1px solid #005c1a; }
        .recv { align-self: flex-start; background: var(--recv-bg); color: #fff; border-bottom-left-radius: 2px; border: 1px solid #333; }
        .shared-img { width: 100%; max-width: 280px; border-radius: 12px; margin-top: 5px; border: 1px solid #444; }

        /* Call Overlay */
        #call-overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 0; }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        #local-video { width: 110px; height: 160px; background: #111; position: absolute; top: 30px; right: 20px; border-radius: 12px; border: 2px solid var(--neon-green); z-index: 3001; object-fit: cover; }
        .call-info { position: relative; z-index: 3002; text-align: center; }
        .call-controls { position: relative; z-index: 3002; display: flex; gap: 40px; margin-bottom: 30px; }
        .call-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }
        .hangup { background: #ff3b30; box-shadow: 0 0 20px rgba(255,59,48,0.4); }
        .answer { background: var(--neon-green); box-shadow: 0 0 20px rgba(0,255,65,0.4); }

        /* Footer Input */
        .footer { padding: 15px; background: var(--panel-bg); display: flex; align-items: center; gap: 12px; border-top: 1px solid #222; }
        .input-box { flex: 1; background: #1a1a1a; border-radius: 30px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; border: 1px solid #333; }
        .input-box input { flex: 1; background: transparent; border: none; color: #fff; outline: none; font-size: 15px; }
        .action-icon { cursor: pointer; color: var(--text-dim); transition: 0.2s; }
        .action-icon:hover { color: var(--neon-green); }
    </style>
</head>
<body>

    <audio id="snd-msg" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-one/bell_small_ring_01.mp3"></audio>
    <audio id="snd-ring" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-61905/zapsplat_multimedia_cell_phone_ring_back_tone_001_64243.mp3" loop></audio>

    <div id="setup-page">
        <div class="glass-card neon-border">
            <h1 style="color:var(--neon-green); margin-bottom:10px; letter-spacing:2px;">ELITE PRIVATE</h1>
            <p style="color:var(--text-dim); margin-bottom:30px; font-size:13px;">ENCRYPTED TERMINAL v20</p>
            <input type="text" id="user-name" class="setup-input" placeholder="ACCESS NAME">
            <button class="setup-input btn-prime" onclick="startApp()">INITIALIZE</button>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <div class="glass-card">
            <div style="width:80px; height:80px; background:var(--panel-bg); border-radius:50%; margin:0 auto 20px; border:1px solid var(--neon-green); display:flex; align-items:center; justify-content:center;">
                <span id="initials" style="font-size:24px; color:var(--neon-green); font-weight:bold;">U</span>
            </div>
            <h2 id="my-n">USER</h2>
            <p style="color:var(--neon-green); margin-bottom:30px; letter-spacing:1px;">IDENTITY PIN: <b id="my-pin">000000</b></p>
            <input type="number" id="target-pin" class="setup-input" placeholder="TARGET PIN">
            <button id="conn-btn" class="setup-input btn-prime" onclick="validatePin()">CONNECT</button>
            <p id="conn-status" style="font-size:12px; color:var(--text-dim);" class="hidden connecting-text">ESTABLISHING SECURE LINK...</p>
        </div>
    </div>

    <div id="chat-window" class="hidden">
        <div class="header">
            <div onclick="closeChat()" style="cursor:pointer; color:var(--neon-green); font-weight:bold;">BACK</div>
            <div style="flex:1">
                <b id="act-n" style="font-size:18px; letter-spacing:1px;">TARGET</b>
                <div style="font-size:11px; color:var(--text-dim);"><span class="status-dot"></span> SECURE CONNECTION</div>
            </div>
            <div style="display:flex; gap:20px;">
                <svg onclick="initiateCall('Video')" class="action-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                <svg onclick="initiateCall('Voice')" class="action-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
        </div>
        <div class="message-area" id="msgs"></div>
        <div class="footer">
            <div class="input-box">
                <svg onclick="document.getElementById('file-in').click()" class="action-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                <input type="text" id="m-in" placeholder="Secure message...">
                <input type="file" id="file-in" accept="image/*" class="hidden" onchange="handleFile(this)">
            </div>
            <button onclick="sendMsg()" style="background:var(--neon-green); border:none; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <div id="call-overlay" class="hidden">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-info">
            <div style="width:120px; height:120px; background:#1a1a1a; border-radius:50%; margin:0 auto 20px; border:2px solid var(--neon-green);"></div>
            <h2 id="call-user-display" style="font-size:32px; letter-spacing:2px;">TARGET</h2>
            <p id="call-status-text" style="color:var(--neon-green); font-size:16px; margin-top:15px; text-transform:uppercase; letter-spacing:3px;">Initializing Signal</p>
        </div>
        <div class="call-controls">
            <button id="ans-btn" class="call-btn answer hidden" onclick="acceptCall()">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#000"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.17-.24c1.05.42 2.19.64 3.39.64a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1c-9.39 0-17-7.61-17-17a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.2.22 2.34.64 3.39a1 1 0 0 1-.24 1.17l-2.2 2.2z"/></svg>
            </button>
            <button class="call-btn hangup" onclick="endCall()">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#fff"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </button>
        </div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4aeKaJI5X3Y9a4MSvc-UfEkvnilBHtxCVCoxDPhOH4XhTJY155HwWdVVkZJguTEiU/exec";
    let db = JSON.parse(localStorage.getItem('ps_db_v20')) || null;
    let chats = JSON.parse(localStorage.getItem('ps_chats_v20')) || {};
    let activePin = localStorage.getItem('ps_active_pin_v20') || null;
    let localStream = null;
    let currentMode = null;

    window.onload = () => { 
        if(db) launch(); 
        if("Notification" in window) Notification.requestPermission();
    };

    function startApp() {
        let n = document.getElementById('user-name').value.toUpperCase();
        if(!n) return;
        let p = Math.floor(100000 + Math.random() * 900000).toString();
        db = { name: n, pin: p };
        localStorage.setItem('ps_db_v20', JSON.stringify(db));
        callServer(`action=register&name=${encodeURIComponent(n)}&pin=${p}`);
        launch();
    }

    function launch() {
        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        document.getElementById('my-n').innerText = db.name;
        document.getElementById('my-pin').innerText = db.pin;
        document.getElementById('initials').innerText = db.name.charAt(0);
        setInterval(sync, 1500); // 1.5s sync for unlimited feel
    }

    function callServer(params, callback) {
        const s = document.createElement('script');
        s.src = `${SCRIPT_URL}?${params}&_t=${Date.now()}${callback ? '&callback='+callback : ''}`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    }

    function validatePin() {
        let pin = document.getElementById('target-pin').value;
        if(!pin) return;
        document.getElementById('conn-status').classList.remove('hidden');
        callServer(`action=getUser&pin=${pin}`, "handleSearch");
    }

    window.handleSearch = (user) => {
        document.getElementById('conn-status').classList.add('hidden');
        if(user && user.name) {
            activePin = user.pin;
            localStorage.setItem('ps_active_pin_v20', user.pin);
            openChat(user.name, user.pin);
        } else alert("SIGNAL LOST: INVALID PIN");
    }

    function openChat(n, pin) {
        activePin = pin;
        document.getElementById('chat-window').classList.remove('hidden');
        document.getElementById('act-n').innerText = n;
        showMsgs();
    }

    function showMsgs() {
        if(!activePin) return;
        const box = document.getElementById('msgs'); box.innerHTML = "";
        (chats[activePin] || []).forEach(m => {
            if(m.type === 'sys') return;
            const isImg = (m.t && m.t.startsWith('data:image'));
            const content = isImg ? `<img src="${m.t}" class="shared-img" onclick="window.open(this.src)">` : m.t;
            box.innerHTML += `<div class="msg ${m.s == db.pin ? 'sent' : 'recv'}">${content}</div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function sendMsg(val = null, type = 'text') {
        let t = val || document.getElementById('m-in').value;
        if(!t || !activePin) return;
        if(!chats[activePin]) chats[activePin] = [];
        chats[activePin].push({ s: db.pin, t: t, type: type });
        localStorage.setItem('ps_chats_v20', JSON.stringify(chats));
        showMsgs();
        document.getElementById('m-in').value = "";
        callServer(`action=send&from=${db.pin}&from_name=${encodeURIComponent(db.name)}&to=${activePin}&msg=${encodeURIComponent(t)}`);
    }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            let r = new FileReader();
            r.onload = (e) => sendMsg(e.target.result, 'img');
            r.readAsDataURL(input.files[0]);
        }
    }

    async function initiateCall(type) {
        currentMode = type;
        document.getElementById('call-overlay').classList.remove('hidden');
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-user-display').innerText = document.getElementById('act-n').innerText;
        document.getElementById('call-status-text').innerText = "LINKING SIGNAL...";
        document.getElementById('snd-ring').play();
        await setupMedia(type);
        sendMsg(`[CALL_REQ:${type}]`, 'sys');
    }

    async function setupMedia(type) {
        try {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'Video', audio: true });
            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('local-video').classList.toggle('hidden', type === 'Voice');
        } catch (e) { endCall(); }
    }

    function acceptCall() {
        document.getElementById('snd-ring').pause();
        document.getElementById('ans-btn').classList.add('hidden');
        document.getElementById('call-status-text').innerText = "SECURE LINE ACTIVE";
        setupMedia(currentMode).then(() => {
            document.getElementById('remote-video').srcObject = localStream;
        });
    }

    function endCall() {
        document.getElementById('snd-ring').pause();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('call-overlay').classList.add('hidden');
        sendMsg("[CALL_END]", 'sys');
    }

    function sync() { 
        if(db) callServer(`action=getMessages&myPin=${db.pin}`, "handleSync"); 
    }

    window.handleSync = (data) => {
        if(data && data.length > 0) {
            data.forEach(m => {
                if(!chats[m.sender]) chats[m.sender] = [];
                if(!chats[m.sender].some(x => x.t === m.text)) {
                    let isCall = m.text.includes("[CALL_REQ:");
                    let isImg = m.text.startsWith('data:image');
                    
                    chats[m.sender].push({ s: m.sender, t: m.text, type: isCall ? 'sys' : (isImg ? 'img' : 'text') });
                    
                    // UNLIMITED AUTO-CONNECT
                    activePin = m.sender;
                    localStorage.setItem('ps_active_pin_v20', m.sender);

                    if(isCall) {
                        currentMode = m.text.includes("Video") ? "Video" : "Voice";
                        document.getElementById('call-overlay').classList.remove('hidden');
                        document.getElementById('ans-btn').classList.remove('hidden');
                        document.getElementById('call-user-display').innerText = m.sender_name;
                        document.getElementById('call-status-text').innerText = `INCOMING ${currentMode} SIGNAL`;
                        document.getElementById('snd-ring').play();
                    } else if(m.text === "[CALL_END]") {
                        endCall();
                    } else {
                        document.getElementById('snd-msg').play();
                        openChat(m.sender_name, m.sender); // Force open chat on message
                        if (Notification.permission === "granted") {
                            let n = new Notification(m.sender_name, { body: isImg ? "IMAGE DATA RECEIVED" : m.text });
                            n.onclick = () => { window.focus(); openChat(m.sender_name, m.sender); };
                        }
                    }
                }
            });
            localStorage.setItem('ps_chats_v20', JSON.stringify(chats));
            showMsgs();
        }
    };

    function closeChat() { document.getElementById('chat-window').classList.add('hidden'); }
</script>
</body>
</html>
